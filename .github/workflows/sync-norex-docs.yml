name: Sync norex Documentation

on:
  # Allow manual trigger
  workflow_dispatch:
  
  # Run hourly
  schedule:
    - cron: '0 * * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout norex.dev repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Clone norex source repository
        run: |
          git clone https://github.com/basti2204/norex.git /tmp/norex-source
          cd /tmp/norex-source
          git checkout 079902b1f042b2227494eb1d4220c8f8a229e956
      
      - name: Check if docs directory exists in source
        id: check_docs
        run: |
          if [ -d "/tmp/norex-source/docs" ]; then
            echo "docs_exist=true" >> $GITHUB_OUTPUT
            echo "âœ… Documentation directory found in source repository"
          else
            echo "docs_exist=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  No docs directory found in source repository"
          fi
      
      - name: Sync documentation files
        if: steps.check_docs.outputs.docs_exist == 'true'
        run: |
          # Create docs directory if it doesn't exist
          mkdir -p docs
          
          # Copy all markdown files from source docs to destination docs
          # Preserve the structure and only copy .md files to avoid overwriting our Docsify setup
          if [ -d "/tmp/norex-source/docs" ]; then
            # Find all .md files and copy them
            find /tmp/norex-source/docs -name "*.md" -type f | while read file; do
              # Get the relative path
              rel_path="${file#/tmp/norex-source/docs/}"
              dest_dir="docs/$(dirname "$rel_path")"
              
              # Create destination directory if needed
              mkdir -p "$dest_dir"
              
              # Copy the file (but preserve our README.md, _sidebar.md)
              base_name=$(basename "$file")
              if [ "$base_name" != "_sidebar.md" ] && [ "$rel_path" != "README.md" ]; then
                cp "$file" "docs/$rel_path"
                echo "ðŸ“„ Copied: $rel_path"
              else
                echo "â­ï¸  Skipped: $rel_path (protected file)"
              fi
            done
          fi
      
      - name: Get source repository info
        id: source_info
        run: |
          cd /tmp/norex-source
          COMMIT_SHA=$(git rev-parse HEAD)
          COMMIT_DATE=$(git log -1 --format=%cd --date=iso)
          COMMIT_MSG=$(git log -1 --format=%s)
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_date=$COMMIT_DATE" >> $GITHUB_OUTPUT
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Sync norex docs (automated)
            
            Source: basti2204/norex@${{ steps.source_info.outputs.commit_sha }}
            Date: ${{ steps.source_info.outputs.commit_date }}
          branch: docs-sync
          delete-branch: false
          title: "ðŸ”„ Sync norex docs (automated)"
          body: |
            ## ðŸ“š Documentation Sync
            
            This PR was automatically created by the documentation sync workflow.
            
            ### Source Information
            - **Repository**: [basti2204/norex](https://github.com/basti2204/norex)
            - **Reference**: `079902b1f042b2227494eb1d4220c8f8a229e956`
            - **Commit**: ${{ steps.source_info.outputs.commit_sha }}
            - **Date**: ${{ steps.source_info.outputs.commit_date }}
            - **Last Commit**: ${{ steps.source_info.outputs.commit_msg }}
            
            ### Changes
            This PR synchronizes the documentation from the norex repository's `docs/` directory to this repository.
            
            ### Workflow
            - **Trigger**: Automated (hourly schedule or manual dispatch)
            - **Workflow**: `.github/workflows/sync-norex-docs.yml`
            
            ### Review
            Please review the changes and merge if everything looks correct. The workflow preserves our custom files:
            - `docs/index.html` (Docsify setup)
            - `docs/_sidebar.md` (Navigation)
            - `docs/README.md` (Landing page with sync info)
            
            ---
            
            *ðŸ¤– This PR was automatically generated by the docs sync workflow*
          labels: |
            documentation
            automated
          draft: false
